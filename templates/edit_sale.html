{% extends "base.html" %}
{% block content %}
<div class="container">
    <div class="header-section">
        <h1>Edit Sale #{{ sale.receipt_number }}</h1>
        <div class="actions-bar">
            <button onclick="history.back()" class="back-button">
                <i class="fas fa-arrow-left"></i> Back
            </button>
        </div>
    </div>

    <form id="editSaleForm" class="modern-form" method="POST">
        {{ form.csrf_token }}
        <div class="form-grid">
            <div class="form-section">
                <div class="form-group">
                    <label>Receipt Number</label>
                    <input type="text" value="{{ sale.receipt_number }}" readonly>
                </div>
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" name="receipt_date" value="{{ sale.receipt_date }}" required>
                </div>
                <div class="form-group">
                    <label>Reference No.</label>
                    <input type="text" value="{{ sale.reference_no }}" readonly>
                </div>
            </div>

            <div class="form-section">
                <div class="form-group">
                    <label>Customer</label>
                    <input type="text" value="{{ sale.customer }}" readonly>
                </div>
                <div class="form-group">
                    <label>Payment Method</label>
                    <select name="payment_method" required>
                        <option value="cash" {% if sale.payment_method == 'cash' %}selected{% endif %}>Cash</option>
                        <option value="card" {% if sale.payment_method == 'card' %}selected{% endif %}>Card</option>
                        <option value="transfer" {% if sale.payment_method == 'transfer' %}selected{% endif %}>Bank Transfer</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="items-section">
            <h3>Items</h3>
            <div id="itemsContainer">
                {% for item in sale.items %}
                <div class="item-row">
                    <div class="form-group">
                        <label>Product</label>
                        <input type="text" value="{{ item.product }}" readonly>
                        <input type="hidden" name="product_ids[]" value="{{ item.product_id }}">
                    </div>
                    <div class="form-group">
                        <label>Quantity</label>
                        <input type="number" name="quantities[]" value="{{ item.quantity }}" min="1" required 
                               data-original="{{ item.quantity }}" class="quantity-input">
                    </div>
                    <div class="form-group">
                        <label>Rate</label>
                        <input type="number" name="rates[]" value="{{ item.rate }}" step="0.01" required class="rate-input">
                    </div>
                    <div class="form-group">
                        <label>Amount</label>
                        <input type="number" name="amounts[]" value="{{ item.amount }}" step="0.01" readonly class="amount-input">
                    </div>
                </div>
                {% endfor %}
            </div>

            <div class="totals-section">
                <div class="form-group">
                    <label>Subtotal</label>
                    <input type="number" name="subtotal" value="{{ sale.subtotal }}" step="0.01" readonly>
                </div>
                <div class="form-group">
                    <label>Discount</label>
                    <input type="number" name="discount" value="{{ sale.discount }}" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label>Total</label>
                    <input type="number" name="total" value="{{ sale.total }}" step="0.01" readonly>
                </div>
            </div>

            <div class="payment-section">
                <div class="form-group">
                    <label>Amount Delivered</label>
                    <input type="number" name="delivered" value="{{ sale.delivered }}" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label>Amount Deposited</label>
                    <input type="number" name="deposited" value="{{ sale.deposited }}" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label>Balance</label>
                    <input type="number" name="balance" value="{{ sale.total - sale.delivered }}" step="0.01" readonly>
                </div>
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="save-button">
                <i class="fas fa-save"></i> Save Changes
            </button>
            <button type="button" onclick="history.back()" class="cancel-button">
                <i class="fas fa-times"></i> Cancel
            </button>
        </div>
    </form>
</div>

{% block extra_css %}
<style>
.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.item-row {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr 1fr;
    gap: 15px;
    padding: 10px;
    background: var(--bg-secondary);
    border-radius: 8px;
    margin-bottom: 10px;
}

.totals-section {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    margin: 20px 0;
    padding: 15px;
    background: var(--bg-secondary);
    border-radius: 8px;
}

.payment-section {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    margin: 20px 0;
    padding: 15px;
    background: var(--success-color-light);
    border-radius: 8px;
}

.form-actions {
    display: flex;
    gap: 15px;
    justify-content: flex-end;
    margin-top: 30px;
}

.save-button, .cancel-button {
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-weight: 500;
}

.save-button {
    background-color: var(--success-color);
    color: white;
}

.cancel-button {
    background-color: var(--danger-color);
    color: white;
}

input[readonly] {
    background-color: var(--bg-disabled);
    cursor: not-allowed;
}
</style>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('editSaleForm');
    
    // Update amounts when quantity or rate changes
    form.addEventListener('input', function(e) {
        if (e.target.matches('.quantity-input') || e.target.matches('.rate-input')) {
            updateItemAmount(e.target.closest('.item-row'));
            updateTotals();
        }
    });
    
    // Update balance when delivered amount changes
    form.querySelector('[name="delivered"]').addEventListener('input', updateBalance);
    form.querySelector('[name="discount"]').addEventListener('input', updateTotals);
    
    // Calculate amount for a single row
    function updateItemAmount(row) {
        const quantity = parseInt(row.querySelector('[name="quantities[]"]').value) || 0;
        const rate = parseFloat(row.querySelector('[name="rates[]"]').value) || 0;
        const amountInput = row.querySelector('[name="amounts[]"]');
        amountInput.value = (quantity * rate).toFixed(2);
    }

    // Calculate totals
    function updateTotals() {
        const amounts = Array.from(form.querySelectorAll('[name="amounts[]"]'))
            .map(input => parseFloat(input.value) || 0);
            
        const subtotal = amounts.reduce((sum, amount) => sum + amount, 0);
        const discount = parseFloat(form.querySelector('[name="discount"]').value) || 0;
        const total = Math.max(0, subtotal - discount);
        
        form.querySelector('[name="subtotal"]').value = subtotal.toFixed(2);
        form.querySelector('[name="total"]').value = total.toFixed(2);
        
        updateBalance();
    }

    // Update balance
    function updateBalance() {
        const total = parseFloat(form.querySelector('[name="total"]').value) || 0;
        const delivered = parseFloat(form.querySelector('[name="delivered"]').value) || 0;
        form.querySelector('[name="balance"]').value = (total - delivered).toFixed(2);
    }

    // Handle form submission
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        try {
            const formData = {
                receipt_date: form.querySelector('[name="receipt_date"]').value,
                payment_method: form.querySelector('[name="payment_method"]').value,
                items: Array.from(form.querySelectorAll('.item-row')).map(row => ({
                    product_id: row.querySelector('[name="product_ids[]"]').value,
                    product: row.querySelector('input[readonly]').value,
                    quantity: parseInt(row.querySelector('[name="quantities[]"]').value),
                    rate: parseFloat(row.querySelector('[name="rates[]"]').value).toFixed(2),
                    amount: parseFloat(row.querySelector('[name="amounts[]"]').value).toFixed(2)
                })),
                subtotal: parseFloat(form.querySelector('[name="subtotal"]').value).toFixed(2),
                discount: parseFloat(form.querySelector('[name="discount"]').value || 0).toFixed(2),
                total: parseFloat(form.querySelector('[name="total"]').value).toFixed(2),
                delivered: parseFloat(form.querySelector('[name="delivered"]').value || 0).toFixed(2),
                deposited: parseFloat(form.querySelector('[name="deposited"]').value || 0).toFixed(2)
            };
            
            const response = await fetch(window.location.href, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': form.querySelector('[name="csrf_token"]').value
                },
                body: JSON.stringify(formData)
            });
            
            const result = await response.json();
            
            if (response.ok) {
                alert('Sale updated successfully');
                window.location.href = '/sales_storage';
            } else {
                throw new Error(result.message || 'Failed to update sale');
            }
        } catch (error) {
            alert(error.message);
        }
    });
});
</script>
{% endblock %}
{% endblock %}